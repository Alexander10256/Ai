# AI Trend Monitor

Скрипт предназначен для круглосуточного (24/7) мониторинга новостных источников и RSS-лент с целью нахождения потенциальных трендов и фильтрации шума.

## Возможности

- Параллельное асинхронное обновление нескольких источников (по умолчанию Google Trends, Hacker News и Lenta.ru) с джиттером повторных попыток.
- Условные HTTP-запросы (If-None-Match/If-Modified-Since) и выдерживание таймаутов, чтобы не грузить ленты при отсутствии обновлений.
- Экспоненциальное затухание значимости старых новостей и гибкая дедупликация по гибридному отпечатку с TTL.
- Языковая детекция и нормализация ключевых слов для английского и русского языков, расширяемые стоп-слова и стемминг.
- Сохранение итоговых трендов в транзакционную SQLite-базу с автоматической очисткой по ретеншну.
- Экспорт метрик Prometheus (успехи, 304, ретраи, длительность итерации, количество новых событий).

## Установка и запуск

```bash
python -m trend_monitor.monitor --storage data/trends.sqlite --interval 1800 --metrics-port 8000
```

Параметры:

- `--interval` — интервал между обновлениями в секундах (по умолчанию 900).
- `--retention` — горизонт анализа в часах (по умолчанию 12).
- `--decay` — параметр экспоненциального затухания (чем меньше, тем быстрее устаревают новости).
- `--min-score` — порог попадания ключевого слова в список трендов.
- `--top` — количество отображаемых трендов.
- `--fetch-retries` — количество повторных попыток при ошибках источника.
- `--fetch-backoff` — базовый множитель паузы между повторными попытками; джиттер добавляется автоматически.
- `--fetch-concurrency` — максимальное число одновременных запросов к лентам.
- `--dedup-ttl` — TTL в минутах для отпечатков статей (по умолчанию равен `--retention`).
- `--once` — выполнить один проход и завершить работу (удобно для теста).
- `--sources` — путь к JSON файлу с дополнительными источниками вида:

```json
[
  {"name": "TechCrunch", "url": "https://techcrunch.com/feed/", "language": "en", "country": "US"},
  {"name": "Meduza", "url": "https://meduza.io/rss/all", "language": "ru", "timeout": 20}
]
```

- `--storage` — путь к SQLite базе данных (создаётся автоматически при первом запуске).
- `--metrics-port` / `--metrics-addr` — адрес для экспорта Prometheus-метрик (`/metrics`).

### Структура хранения

Внутри базы создаются три таблицы: `snapshots`, `trends`, `trend_items`. Каждое сохранение выполняется в транзакции, старые снимки удаляются по условию `generated_at < now - retention`. По достижении порога `vacuum_every` выполняется `VACUUM`, чтобы база не разрасталась.

## Как работает фильтрация

1. Каждая новость разбивается на ключевые слова, язык определяется автоматически или берётся из конфигурации источника. Стоп-слова и нормализация учитывают язык (Snowball-стеммер, fallback суффиксы).
2. Вес новости уменьшается экспоненциально со временем, что позволяет сфокусироваться на свежих событиях.
3. Ключевые слова из заголовков получают больший вес, чем из краткого описания, после чего агрегируются по всем источникам и ограничиваются заданным порогом.

### Надёжность и наблюдаемость

- Для каждого RSS-запроса можно задать таймаут, количество повторных попыток и базовый backoff (см. `SourceConfig`).
- Повторные попытки выполняются с экспоненциальной задержкой и джиттером, чтобы избегать «волн» запросов.
- Кеширование ETag/Last-Modified и дедупликация отпечатков предотвращают повторную обработку уже увиденных материалов.
- Метрики Prometheus позволяют отслеживать число успешных/неуспешных запросов, количество повторных попыток, 304-ответов, новых событий и длительность итераций.

## Расширение

- Добавляйте собственные RSS-источники через JSON-конфигурацию, указывая язык и страну для лучшей нормализации.
- Настройте cron/systemd для непрерывного запуска на сервере.
- При необходимости расширяйте списки стоп-слов и поддерживаемые языки в `trend_monitor/analysis.py`.
- Запустите тесты `pytest` перед выкладкой изменений, чтобы убедиться в корректности анализа, мониторинга и хранения.
